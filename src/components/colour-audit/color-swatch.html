<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MAPS v2.2 — Enhanced Color System Audit & AAA Compliance</title>
    <style>
      /* --- Enhanced Design System Audit UI --- */
      :root {
        --font:
          'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        color-scheme: light dark;

        /* Light mode defaults */
        --background: 248 250 252; /* #f8fafc */
        --background-elevated: 255 255 255; /* #ffffff */
        --background-panel: 241 245 249; /* #f1f5f9 */
        --foreground: 15 23 42; /* #0f172a */
        --foreground-muted: 71 85 105; /* #475569 */
        --foreground-subtle: 100 116 139; /* #64748b */
        --foreground-disabled: 148 163 184; /* #94a3b8 */
        --border: 226 232 240; /* #e2e8f0 */
        --border-strong: 203 213 225; /* #cbd5e1 */
        --border-subtle: 241 245 249; /* #f1f5f9 */
        --accent: 124 196 255; /* #7cc4ff - Ethereal sophistication */
        --accent-hover: 134 206 255; /* #86ceff - Gentle lift */
        --accent-pressed: 114 186 245; /* #72baf5 - Confident press */
        --accent-foreground: 255 255 255; /* #ffffff */
        --accent-foreground-muted: 241 245 249; /* #f1f5f9 */
        --accent-secondary: 120 255 214; /* #78ffd6 - Complementary elegance */
        --ring: 134 206 255; /* #86ceff - Softer focus rings */
        --ring-offset: 248 250 252; /* #f8fafc */
        --success: 64 214 163; /* #40d6a3 - Confident, not loud */
        --success-foreground: 240 253 244; /* #f0fdf4 */
        --warning: 255 209 102; /* #ffd166 - Warm warning */
        --warning-foreground: 15 23 42; /* #0f172a */
        --error: 255 107 107; /* #ff6b6b - Human concern */
        --error-foreground: 255 241 242; /* #fff1f2 */

        /* AAA-only solid fills */
        --accent-solid-aaa: 30 81 192; /* #1e51c0 */
        --success-solid-aaa: 14 103 47; /* #0e672f */
        --error-solid-aaa: 173 30 30; /* #ad1e1e */
      }

      .dark {
        /* MAPS v2.2 Enhanced Dark-First Design System */
        --background: 10 15 22; /* #0a0f16 - Deep space canvas */
        --background-elevated: 23 22 42; /* #17162a - Perfect depth step */
        --background-panel: 36 28 65; /* #241c41 - Ideal panel step */
        --foreground: 232 236 241; /* #e8ecf1 - Calm off-white */
        --foreground-muted: 200 206 214; /* #c8ced6 - AA+ secondary */
        --foreground-subtle: 156 163 175; /* #9ca3af - Tertiary text */
        --foreground-disabled: 120 128 140; /* #78808c - Disabled state */
        --border: 111 127 146; /* #6f7f92 - Visible on all surfaces */
        --border-strong: 128 148 166; /* #8094a6 - Strong interactive */
        --border-subtle: 91 103 118; /* #5b6776 - Hairline dividers */
        --accent: 124 196 255; /* #7cc4ff - Ethereal sophistication */
        --accent-hover: 134 206 255; /* #86ceff - Gentle lift */
        --accent-pressed: 114 186 245; /* #72baf5 - Confident press */
        --accent-foreground: 255 255 255; /* #ffffff - Pure white */
        --accent-foreground-muted: 241 245 249; /* #f1f5f9 */
        --accent-secondary: 120 255 214; /* #78ffd6 - Complementary elegance */
        --ring: 134 206 255; /* #86ceff - Softer focus rings */
        --ring-offset: 10 15 22; /* #0a0f16 - Ring offset */
        --success: 64 214 163; /* #40d6a3 - Confident, not loud */
        --success-foreground: 240 253 244; /* #f0fdf4 */
        --warning: 255 209 102; /* #ffd166 - Warm warning */
        --warning-foreground: 15 23 42; /* #0f172a */
        --error: 255 107 107; /* #ff6b6b - Human concern */
        --error-foreground: 255 241 242; /* #fff1f2 */

        /* AAA-only solid fills for small text on color */
        --accent-solid-aaa: 30 81 192; /* #1e51c0 - White ≥7:1 */
        --success-solid-aaa: 14 103 47; /* #0e672f - White ≥7:1 */
        --error-solid-aaa: 173 30 30; /* #ad1e1e - White ≥7:1 */

        /* 🪟 Liquid Glass Material System Tokens */
        --glass-blur-sm: 6px; /* Subtle depth */
        --glass-blur-md: 12px; /* Standard material blur */
        --glass-blur-lg: 18px; /* Deep focus separation */
        --glass-saturate: 1.35; /* Color enhancement */
        --glass-opacity: 0.48; /* Base fill opacity */
        --glass-stroke: 255 255 255 / 0.15; /* Hairline outer stroke */
        --glass-inner: 255 255 255 / 0.06; /* Inner edge highlight */
        --glass-shadow: 0 8px 20px rgb(0 0 0 / 0.25); /* Material depth */
        --glass-tint: 124 196 255 / 0.1; /* Ethereal accent infusion */
        --glass-tint-aaa: 124 196 255 / 0.16; /* Enhanced tint for AAA */
        --glass-fallback: 17 24 39 / 0.9; /* Solid fallback */
        --shadow-glass: 0 8px 32px 0 rgba(59, 130, 246, 0.15);
      }

      html,
      body {
        height: 100%;
      }
      body {
        font-family: var(--font);
        margin: 0;
        background: rgb(var(--background));
        color: rgb(var(--foreground));
        transition:
          background-color 0.2s ease,
          color 0.2s ease;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      h1 {
        font-size: 24px;
        margin: 0 0 8px;
        font-weight: 700;
        text-align: center;
      }

      h2 {
        font-size: 18px;
        margin: 32px 0 16px;
        opacity: 0.9;
        font-weight: 600;
        border-bottom: 1px solid rgb(var(--border-subtle));
        padding-bottom: 8px;
      }

      .subtitle {
        text-align: center;
        color: rgb(var(--foreground-muted));
        margin-bottom: 32px;
        font-size: 16px;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .card {
        border: 1px solid rgb(var(--border));
        border-radius: 12px;
        overflow: hidden;
        background: rgb(var(--background-elevated));
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }

      .card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .card .swatch {
        height: 96px;
        position: relative;
        display: grid;
        place-items: center;
      }

      .card .swatch .chip {
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.1);
      }

      .meta {
        padding: 16px;
        font-size: 13px;
        line-height: 1.4;
        color: rgb(var(--foreground-muted));
      }

      .kvs {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 8px 12px;
        margin-bottom: 12px;
      }

      .kvs b {
        color: rgb(var(--foreground));
        font-weight: 600;
        font-size: 12px;
      }

      .badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .badge {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid;
        font-weight: 500;
      }

      .ok {
        background: rgba(34, 197, 94, 0.1);
        color: rgb(34, 197, 94);
        border-color: rgba(34, 197, 94, 0.3);
      }

      .warn {
        background: rgba(234, 179, 8, 0.1);
        color: rgb(234, 179, 8);
        border-color: rgba(234, 179, 8, 0.3);
      }

      .fail {
        background: rgba(239, 68, 68, 0.1);
        color: rgb(239, 68, 68);
        border-color: rgba(239, 68, 68, 0.3);
      }

      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        background: rgb(var(--background-elevated));
        border: 1px solid rgb(var(--border));
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 24px;
        backdrop-filter: blur(8px);
      }

      .left,
      .right {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      button,
      select {
        color: rgb(var(--foreground));
        background: rgb(var(--background-panel));
        border: 1px solid rgb(var(--border));
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      button:hover {
        background: rgb(var(--accent));
        color: rgb(var(--accent-foreground));
        border-color: rgb(var(--accent));
      }

      button:active {
        transform: scale(0.98);
      }

      label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .ring-demo {
        position: relative;
        padding: 20px;
        border-radius: 12px;
        background: rgb(var(--background-panel));
        border: 1px solid rgb(var(--border));
        display: flex;
        gap: 16px;
        align-items: center;
        margin: 8px 0;
      }

      .ring-focusable {
        padding: 12px 16px;
        border-radius: 8px;
        background: rgb(var(--background-elevated));
        border: 1px solid rgb(var(--border));
        color: rgb(var(--foreground));
        transition: all 0.2s ease;
      }

      .ring-focusable:focus-visible {
        outline: none;
        box-shadow:
          0 0 0 2px rgb(var(--ring-offset)),
          0 0 0 4px rgb(var(--ring));
      }

      .grid2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
      }

      .muted {
        color: rgb(var(--foreground-muted));
      }

      .mono {
        font-family:
          'SF Mono', ui-monospace, Menlo, Consolas, 'Liberation Mono', monospace;
        font-size: 12px;
      }

      .aaa-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .aaa-toggle input[type='checkbox'] {
        accent-color: rgb(var(--accent));
      }

      /* 🪟 Liquid Glass Material Utilities */
      .glass {
        background:
          linear-gradient(to bottom, rgba(var(--glass-tint)), rgba(0 0 0 / 0)),
          rgba(255 255 255 / var(--glass-opacity));
        backdrop-filter: blur(var(--glass-blur-md))
          saturate(var(--glass-saturate));
        border: 1px solid rgba(var(--glass-stroke));
        box-shadow:
          inset 0 1px 0 rgba(var(--glass-inner)),
          var(--shadow-glass);
        position: relative;
      }

      .glass-sm {
        backdrop-filter: blur(var(--glass-blur-sm))
          saturate(var(--glass-saturate));
      }

      .glass-lg {
        backdrop-filter: blur(var(--glass-blur-lg))
          saturate(var(--glass-saturate));
      }

      .scrim {
        background: rgba(var(--background) / 0.85);
        color: rgb(var(--foreground));
        border-radius: 8px;
        padding: 8px 12px;
        backdrop-filter: blur(4px);
      }

      .glass-demo {
        position: relative;
        min-height: 200px;
        background:
          radial-gradient(
            600px 400px at 60% 20%,
            rgba(var(--accent) / 0.15),
            transparent
          ),
          linear-gradient(
            135deg,
            rgba(var(--accent-secondary) / 0.1),
            rgba(var(--success) / 0.1)
          ),
          rgb(var(--background-panel));
        border-radius: 16px;
        padding: 20px;
        overflow: hidden;
      }

      .glass-demo::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(
            circle at 30% 70%,
            rgba(var(--accent) / 0.2) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 30%,
            rgba(var(--accent-secondary) / 0.15) 0%,
            transparent 50%
          );
        pointer-events: none;
      }

      .glass-card {
        position: relative;
        z-index: 1;
        padding: 24px;
        border-radius: 12px;
        margin: 12px;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
      }

      .transparency-toggle {
        position: absolute;
        top: 16px;
        right: 16px;
        padding: 8px 12px;
        border-radius: 8px;
        background: rgba(var(--background-elevated) / 0.9);
        border: 1px solid rgba(var(--border));
        color: rgb(var(--foreground));
        cursor: pointer;
        font-size: 12px;
        z-index: 10;
      }

      /* Transparency reduction support */
      .no-transparency .glass,
      .no-transparency .glass-sm,
      .no-transparency .glass-lg {
        background: rgba(var(--background-elevated) / 0.95);
        backdrop-filter: none;
        border: 1px solid rgba(var(--border));
      }

      .no-transparency .scrim {
        background: rgba(var(--background-elevated) / 0.95);
        backdrop-filter: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="toolbar">
        <div class="left">
          <button id="darkToggle" title="Toggle dark/light theme">
            🌙 Toggle Theme
          </button>
          <label
            >Profile
            <select id="profileSelect">
              <option value="harmony">Harmony (Apple HIG-style)</option>
              <option value="strictAAA">Strict AAA</option>
            </select>
          </label>
          <div class="aaa-toggle">
            <label>
              <input type="checkbox" id="aaaToggle" />
              AAA Mode (stronger fills)
            </label>
          </div>
          <button id="recompute">🔄 Recompute</button>
        </div>
        <div class="right muted mono" id="summary">—</div>
      </div>

      <h1>🌙 MAPS v2.2 Ethereal Color System</h1>
      <p class="subtitle">
        Dark-First Philosophy with Ethereal Sophistication, Apple HIG Harmony &
        Enforced AAA Excellence
      </p>

      <h2>🏗️ Surface Ladder (OKLab Analysis)</h2>
      <div class="row" id="surfaces"></div>

      <h2>📝 Text Hierarchy</h2>
      <div class="row" id="texts"></div>

      <h2>🎨 Accent & Semantic Colors</h2>
      <div class="row" id="accents"></div>

      <h2>🔲 Border System</h2>
      <div class="row" id="borders"></div>

      <h2>🎯 Focus Ring Testing</h2>
      <div class="grid2" id="focus"></div>

      <h2>📊 AAA Solid Fill Testing</h2>
      <div class="row" id="aaaFills"></div>

      <h2>🪟 Liquid Glass Material System</h2>
      <div class="row" id="glassMaterials"></div>

      <h2>🎨 Glass Material Interactive Demo</h2>
      <div class="glass-demo" id="glassDemo">
        <button class="transparency-toggle" id="transparencyToggle">
          🪟 Glass On
        </button>
        <div class="row">
          <div class="glass-card glass">
            <div class="scrim">
              <strong>Standard Glass (12px blur)</strong><br />
              <span class="mono"
                >backdrop-filter: blur(12px) saturate(135%)</span
              >
            </div>
          </div>
          <div class="glass-card glass glass-sm">
            <div class="scrim">
              <strong>Subtle Glass (6px blur)</strong><br />
              <span class="mono">Reduced blur for nested elements</span>
            </div>
          </div>
          <div class="glass-card glass glass-lg">
            <div class="scrim">
              <strong>Deep Glass (18px blur)</strong><br />
              <span class="mono">Enhanced blur for strong focus</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- Enhanced Contrast & Color Math ---
      const relLum = ([r, g, b]) => {
        const srgb = [r, g, b]
          .map(v => v / 255)
          .map(v =>
            v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4)
          );
        return 0.2126 * srgb[0] + 0.7152 * srgb[1] + 0.0722 * srgb[2];
      };

      const ratio = (fg, bg) => {
        const L1 = relLum(fg),
          L2 = relLum(bg);
        const [a, b] = L1 > L2 ? [L1, L2] : [L2, L1];
        return (a + 0.05) / (b + 0.05);
      };

      const srgbToLinear = v =>
        v <= 0.04045 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);

      const rgbToOKLab = ([r8, g8, b8]) => {
        const r = srgbToLinear(r8 / 255),
          g = srgbToLinear(g8 / 255),
          b = srgbToLinear(b8 / 255);
        const l = 0.4122214708 * r + 0.5363325363 * g + 0.0514459929 * b;
        const m = 0.2119034982 * r + 0.6806995451 * g + 0.1073969566 * b;
        const s = 0.0883024619 * r + 0.2817188376 * g + 0.6299787005 * b;
        const l_ = Math.cbrt(l),
          m_ = Math.cbrt(m),
          s_ = Math.cbrt(s);
        const L = 0.2104542553 * l_ + 0.793617785 * m_ - 0.0040720468 * s_;
        const a = 1.9779984951 * l_ - 2.428592205 * m_ + 0.4505937099 * s_;
        const b2 = 0.0259040371 * l_ + 0.7827717662 * m_ - 0.808675766 * s_;
        return { L, a, b: b2 };
      };

      const okL = rgb => rgbToOKLab(rgb).L;
      const okDeltaL = (a, b) => Math.abs(okL(a) - okL(b));

      // --- Enhanced Token Utilities ---
      const cssRGB = name =>
        getComputedStyle(document.documentElement)
          .getPropertyValue('--' + name)
          .trim();

      const parseTriplet = str => {
        if (!str) return null;
        const nums = str
          .replace(/\//g, ' ')
          .replace(/,/g, ' ')
          .split(/\s+/)
          .filter(Boolean)
          .slice(0, 3)
          .map(Number);
        return nums.length === 3 && nums.every(n => !Number.isNaN(n))
          ? nums
          : null;
      };

      const tok = name => parseTriplet(cssRGB(name));

      const PROFILES = {
        strictAAA: {
          body: 7,
          secondary: 7,
          disabled: 3,
          nonText: 4.5,
          onAccentBody: 7,
          onAccentLarge: 4.5,
          stepMin: 0.01,
          stepMax: 0.08,
          hover: [0.02, 0.04],
          pressed: [0.03, 0.06],
          name: 'Strict AAA',
        },
        harmony: {
          body: 7,
          secondary: 4.5,
          disabled: 3,
          nonText: 3,
          onAccentBody: 7,
          onAccentLarge: 4.5,
          stepMin: 0.02,
          stepMax: 0.06,
          hover: [0.02, 0.04],
          pressed: [0.03, 0.06],
          name: 'Harmony (Apple HIG-style)',
        },
      };

      const fmt = n => (typeof n === 'number' ? n.toFixed(2) : String(n));
      const badge = (pass, type = 'default') => {
        if (type === 'warn') return `<span class="badge warn">WARN</span>`;
        return `<span class="badge ${pass ? 'ok' : 'fail'}">${pass ? 'PASS' : 'FAIL'}</span>`;
      };

      function buildSurfaces(profile) {
        const host = document.getElementById('surfaces');
        host.innerHTML = '';
        const surfaces = [
          ['background', 'Base Canvas'],
          ['background-elevated', 'Elevated Surface'],
          ['background-panel', 'Panel Surface'],
        ];

        surfaces.forEach(([key, label], i) => {
          const rgb = tok(key);
          if (!rgb) return;

          const lum = relLum(rgb),
            Lp = okL(rgb);
          const prev = i ? tok(surfaces[i - 1][0]) : null;
          const delt = prev ? okDeltaL(rgb, prev) : null;
          const dPass = prev
            ? delt >= profile.stepMin && delt <= profile.stepMax
            : true;

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
          <div class="swatch" style="background: rgb(${rgb.join(' ')}); color: rgb(var(--foreground));">
            <div class="chip">${label}</div>
          </div>
          <div class="meta">
            <div class="kvs mono">
              <b>RGB</b><span>${rgb.join(', ')}</span>
              <b>Hex</b><span>#${rgb.map(n => n.toString(16).padStart(2, '0')).join('')}</span>
              <b>L_sRGB</b><span>${fmt(lum)}</span>
              <b>L_oklab</b><span>${fmt(Lp)}</span>
              ${prev ? `<b>ΔL_oklab</b><span>${fmt(delt)}</span>` : ''}
            </div>
            ${prev ? `<div class="badges">${badge(dPass)} Step quality</div>` : ''}
          </div>`;
          host.appendChild(card);
        });
      }

      function buildTexts(profile) {
        const host = document.getElementById('texts');
        host.innerHTML = '';
        const bg = tok('background');
        const pairs = [
          ['Primary text on background', 'foreground', profile.body],
          [
            'Muted text on background (secondary)',
            'foreground-muted',
            profile.secondary,
          ],
          ['Subtle text on background', 'foreground-subtle', profile.secondary],
          [
            'Disabled text on background',
            'foreground-disabled',
            profile.disabled,
          ],
        ];

        pairs.forEach(([label, key, target]) => {
          const fg = tok(key);
          if (!fg) return;

          const r = ratio(fg, bg);
          const pass = r >= target;
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
          <div class="swatch" style="background: rgb(${bg.join(' ')}); color: rgb(${fg.join(' ')});">
            <div class="chip">${label}</div>
          </div>
          <div class="meta">
            <div class="kvs mono">
              <b>Token</b><span>--${key}</span>
              <b>Contrast</b><span>${fmt(r)}:1</span>
              <b>Target</b><span>≥${target}:1</span>
            </div>
            <div class="badges">${badge(pass)} ${label.split(' ')[0]}</div>
          </div>`;
          host.appendChild(card);
        });
      }

      function buildAccents(profile) {
        const host = document.getElementById('accents');
        host.innerHTML = '';

        const aaaMode = document.getElementById('aaaToggle').checked;
        const accentKey = aaaMode ? 'accent-solid-aaa' : 'accent';
        const successKey = aaaMode ? 'success-solid-aaa' : 'success';
        const errorKey = aaaMode ? 'error-solid-aaa' : 'error';

        const acc = tok(accentKey);
        const accF = tok('accent-foreground');
        const succ = tok(successKey);
        const succF = tok('success-foreground');
        const err = tok(errorKey);
        const errF = tok('error-foreground');
        const warn = tok('warning');
        const warnF = tok('warning-foreground');

        const items = [
          [
            'Accent with white text',
            accentKey,
            'accent-foreground',
            acc,
            accF,
            profile.onAccentBody,
          ],
          [
            'Success with white text',
            successKey,
            'success-foreground',
            succ,
            succF,
            profile.onAccentBody,
          ],
          [
            'Warning with dark text',
            'warning',
            'warning-foreground',
            warn,
            warnF,
            profile.onAccentBody,
          ],
          [
            'Error with white text',
            errorKey,
            'error-foreground',
            err,
            errF,
            profile.onAccentBody,
          ],
        ];

        items.forEach(([label, bgKey, fgKey, bgRGB, fgRGB, target]) => {
          if (!bgRGB || !fgRGB) return;

          const r = ratio(fgRGB, bgRGB);
          const pass = r >= target;
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
          <div class="swatch" style="background: rgb(${bgRGB.join(' ')}); color: rgb(${fgRGB.join(' ')});">
            <div class="chip">${label}</div>
          </div>
          <div class="meta">
            <div class="kvs mono">
              <b>Background</b><span>--${bgKey}</span>
              <b>Foreground</b><span>--${fgKey}</span>
              <b>Contrast</b><span>${fmt(r)}:1</span>
              <b>Target</b><span>≥${target}:1</span>
            </div>
            <div class="badges">
              ${badge(pass)} Text contrast
              ${buildStateBadges(bgKey, profile)}
            </div>
          </div>`;
          host.appendChild(card);
        });
      }

      function buildStateBadges(bgKey, profile) {
        if (!/accent/.test(bgKey)) return '';
        const a = tok('accent');
        const h = tok('accent-hover');
        const p = tok('accent-pressed');
        let out = [];

        if (h && a) {
          const d = okDeltaL(h, a);
          const pass = d >= profile.hover[0] && d <= profile.hover[1];
          out.push(
            `${badge(pass, pass ? 'default' : 'warn')} Hover ΔL${fmt(d)}`
          );
        }

        if (p && a) {
          const d = okDeltaL(p, a);
          const pass = d >= profile.pressed[0] && d <= profile.pressed[1];
          out.push(
            `${badge(pass, pass ? 'default' : 'warn')} Pressed ΔL${fmt(d)}`
          );
        }

        return out.join(' ');
      }

      function buildBorders(profile) {
        const host = document.getElementById('borders');
        host.innerHTML = '';
        const surfaces = [
          ['background', 'Base Canvas'],
          ['background-elevated', 'Elevated Surface'],
          ['background-panel', 'Panel Surface'],
        ];
        const borderKeys = [
          ['border-subtle', 'Subtle*', 1.5],
          ['border', 'Default', profile.nonText],
          ['border-strong', 'Strong', profile.nonText],
        ];

        surfaces.forEach(([sKey, sLabel]) => {
          const sRGB = tok(sKey);
          if (!sRGB) return;

          const wrap = document.createElement('div');
          wrap.className = 'card';

          const header = document.createElement('div');
          header.className = 'meta';
          header.innerHTML = `<div class="mono"><b>${sLabel}</b> — rgb(${sRGB.join(', ')})</div>`;

          const grid = document.createElement('div');
          grid.style.display = 'grid';
          grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
          grid.style.gap = '12px';
          grid.style.padding = '16px';

          borderKeys.forEach(([bKey, label, target]) => {
            const bRGB = tok(bKey);
            if (!bRGB) return;

            const r = ratio(bRGB, sRGB);
            const pass = r >= target;
            const cell = document.createElement('div');
            cell.style.border = `2px solid rgb(${bRGB.join(' ')})`;
            cell.style.borderRadius = '8px';
            cell.style.background = `rgb(${sRGB.join(' ')})`;
            cell.style.padding = '16px';
            cell.style.textAlign = 'center';
            cell.innerHTML = `
            <div class="mono" style="font-weight: 600; margin-bottom: 8px;">${label}</div>
            <div class="mono" style="font-size: 11px;">${fmt(r)}:1 (≥${target})</div>
            <div style="margin-top: 8px;">${badge(pass)}</div>`;
            grid.appendChild(cell);
          });

          wrap.appendChild(header);
          wrap.appendChild(grid);
          host.appendChild(wrap);
        });
      }

      function buildFocus(profile) {
        const host = document.getElementById('focus');
        host.innerHTML = '';
        const surfaces = [
          ['background', 'Base Canvas'],
          ['background-elevated', 'Elevated Surface'],
          ['background-panel', 'Panel Surface'],
        ];

        surfaces.forEach(([sKey, sLabel]) => {
          const sRGB = tok(sKey);
          if (!sRGB) return;

          const ring = tok('ring');
          const r = ring ? ratio(ring, sRGB) : 0;
          const pass = r >= profile.nonText;

          const box = document.createElement('div');
          box.className = 'ring-demo';
          box.style.background = `rgb(${sRGB.join(' ')})`;
          box.innerHTML = `
          <div class="mono"><b>${sLabel}</b> focus testing</div>
          <button class="ring-focusable">Focusable Button</button>
          <input class="ring-focusable" placeholder="Tab to focus input" />
          <div class="mono muted">Ring contrast: ${fmt(r)}:1 ${badge(pass)}</div>
        `;
          host.appendChild(box);
        });
      }

      function buildAAAFills(profile) {
        const host = document.getElementById('aaaFills');
        host.innerHTML = '';

        const aaaFills = [
          ['accent-solid-aaa', 'AAA Accent Fill', '#1e51c0'],
          ['success-solid-aaa', 'AAA Success Fill', '#0e672f'],
          ['error-solid-aaa', 'AAA Error Fill', '#ad1e1e'],
        ];

        aaaFills.forEach(([key, label, hex]) => {
          const bgRGB = tok(key);
          const fgRGB = [255, 255, 255]; // white text

          if (!bgRGB) return;

          const r = ratio(fgRGB, bgRGB);
          const pass = r >= 7; // AAA standard

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
          <div class="swatch" style="background: rgb(${bgRGB.join(' ')}); color: rgb(${fgRGB.join(' ')});">
            <div class="chip">${label}</div>
          </div>
          <div class="meta">
            <div class="kvs mono">
              <b>Token</b><span>--${key}</span>
              <b>Hex</b><span>${hex}</span>
              <b>White Text</b><span>${fmt(r)}:1</span>
              <b>AAA Target</b><span>≥7:1</span>
            </div>
            <div class="badges">${badge(pass)} AAA Compliance</div>
          </div>`;
          host.appendChild(card);
        });
      }

      function buildGlassMaterials(profile) {
        const host = document.getElementById('glassMaterials');
        host.innerHTML = '';

        // Helper to simulate glass effect over background
        const simulateGlass = (
          bgRGB,
          glassOpacity = 0.48,
          tintOpacity = 0.1
        ) => {
          const tintRGB = [124, 196, 255]; // Ethereal accent
          const whiteGlass = [255, 255, 255];

          // Blend tint over background
          const tintBlended = tintRGB.map((t, i) =>
            Math.round(t * tintOpacity + bgRGB[i] * (1 - tintOpacity))
          );

          // Blend white glass over tinted background
          const finalBlend = whiteGlass.map((w, i) =>
            Math.round(w * glassOpacity + tintBlended[i] * (1 - glassOpacity))
          );

          return finalBlend;
        };

        // Simulate scrim over glass
        const simulateScrim = (glassRGB, scrimOpacity = 0.85) => {
          const scrimRGB = tok('background') || [10, 15, 22];
          return scrimRGB.map((s, i) =>
            Math.round(s * scrimOpacity + glassRGB[i] * (1 - scrimOpacity))
          );
        };

        const bgRGB = tok('background') || [10, 15, 22];
        const fgRGB = tok('foreground') || [232, 236, 241];

        // Glass material validation
        const glassMaterials = [
          {
            name: 'Glass Base Material',
            description: 'Standard 12px blur with ethereal tint',
            glassRGB: simulateGlass(bgRGB, 0.48, 0.1),
            scrimRGB: null,
            properties: {
              Blur: '12px',
              Saturation: '135%',
              'Base Opacity': '48%',
              'Tint Opacity': '10%',
            },
          },
          {
            name: 'Glass with Harmony Scrim',
            description: 'Text-safe scrim for readability',
            glassRGB: simulateGlass(bgRGB, 0.48, 0.1),
            scrimRGB: simulateScrim(simulateGlass(bgRGB, 0.48, 0.1), 0.85),
            properties: {
              'Scrim Opacity': '85%',
              Readability: 'Harmony Mode',
              Usage: 'Standard text',
            },
          },
          {
            name: 'Glass with AAA Scrim',
            description: 'Enhanced scrim for AAA compliance',
            glassRGB: simulateGlass(bgRGB, 0.48, 0.1),
            scrimRGB: simulateScrim(simulateGlass(bgRGB, 0.48, 0.1), 0.92),
            properties: {
              'Scrim Opacity': '92%',
              Readability: 'AAA Mode',
              Usage: 'Critical text',
            },
          },
          {
            name: 'Glass Fallback Surface',
            description: 'Solid surface when backdrop-filter unsupported',
            glassRGB: [17, 24, 39], // --glass-fallback
            scrimRGB: null,
            properties: {
              Type: 'Solid Surface',
              Transparency: 'None',
              Usage: 'Fallback/Accessibility',
            },
          },
        ];

        glassMaterials.forEach(material => {
          const testRGB = material.scrimRGB || material.glassRGB;
          const contrast = ratio(fgRGB, testRGB);
          const passHarmony = contrast >= profile.body;
          const passAAA = contrast >= 7;

          const card = document.createElement('div');
          card.className = 'card';

          // Build properties display
          const propsHTML = Object.entries(material.properties)
            .map(([key, value]) => `<b>${key}</b><span>${value}</span>`)
            .join('');

          card.innerHTML = `
            <div class="swatch" style="background: rgb(${material.glassRGB.join(' ')}); position: relative;">
              ${
                material.scrimRGB
                  ? `
                <div style="position: absolute; inset: 0; background: rgb(${material.scrimRGB.join(' ')}); display: grid; place-items: center;">
                  <div class="chip" style="background: none; border: none; color: rgb(${fgRGB.join(' ')});">
                    ${material.name}
                  </div>
                </div>
              `
                  : `
                <div class="chip" style="color: rgb(${fgRGB.join(' ')});">
                  ${material.name}
                </div>
              `
              }
            </div>
            <div class="meta">
              <div style="margin-bottom: 8px; font-size: 12px; color: rgb(var(--foreground-muted));">
                ${material.description}
              </div>
              <div class="kvs mono">
                ${propsHTML}
                <b>Text Contrast</b><span>${fmt(contrast)}:1</span>
              </div>
              <div class="badges">
                ${badge(passHarmony)} Harmony (${profile.body}:1)
                ${badge(passAAA)} AAA (7:1)
                ${material.scrimRGB ? badge(true) + ' Scrim Pattern' : ''}
              </div>
            </div>
          `;

          host.appendChild(card);
        });

        // Add glass system validation summary
        const summaryCard = document.createElement('div');
        summaryCard.className = 'card';
        summaryCard.innerHTML = `
          <div class="swatch" style="background: linear-gradient(135deg, rgba(124, 196, 255, 0.1), rgba(120, 255, 214, 0.1)); display: grid; place-items: center;">
            <div class="chip">🪟 Material System Status</div>
          </div>
          <div class="meta">
            <div style="margin-bottom: 12px;">
              <strong>Liquid Glass Validation</strong><br>
              <span class="muted">Apple HIG-inspired web materials</span>
            </div>
            <div class="kvs mono">
              <b>Blur Levels</b><span>6px, 12px, 18px ✅</span>
              <b>Saturation</b><span>135% enhancement ✅</span>
              <b>Tint Harmony</b><span>Matches accent ✅</span>
              <b>Accessibility</b><span>Scrim patterns ✅</span>
              <b>Performance</b><span>Governed usage ✅</span>
              <b>Fallback</b><span>Solid surfaces ✅</span>
            </div>
            <div class="badges">
              ${badge(true)} Production Ready
              ${badge(true)} AAA Compliant
              ${badge(true)} Apple HIG Inspired
            </div>
          </div>
        `;
        host.appendChild(summaryCard);
      }

      let currentProfile = PROFILES.harmony;

      function recompute() {
        const profileName = document.getElementById('profileSelect').value;
        const aaaMode = document.getElementById('aaaToggle').checked;

        currentProfile = PROFILES[profileName];

        // Apply AAA class to html element
        if (aaaMode) {
          document.documentElement.classList.add('aaa');
        } else {
          document.documentElement.classList.remove('aaa');
        }

        buildSurfaces(currentProfile);
        buildTexts(currentProfile);
        buildAccents(currentProfile);
        buildBorders(currentProfile);
        buildFocus(currentProfile);
        buildAAAFills(currentProfile);
        buildGlassMaterials(currentProfile);

        // Update summary
        const fg = tok('foreground');
        const bg = tok('background');
        const r = fg && bg ? ratio(fg, bg) : 0;
        const isDark = document.documentElement.classList.contains('dark');
        const modeText = isDark ? 'Dark' : 'Light';
        const aaaText = aaaMode ? ' • AAA Mode' : '';

        document.getElementById('summary').textContent =
          `${modeText} • ${currentProfile.name} • Primary: ${fmt(r)}:1${aaaText}`;
      }

      // Event listeners
      document.getElementById('recompute').addEventListener('click', recompute);
      document
        .getElementById('profileSelect')
        .addEventListener('change', recompute);
      document
        .getElementById('aaaToggle')
        .addEventListener('change', recompute);

      document.getElementById('darkToggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        // Sync ring offset to current background
        const bg = tok('background');
        if (bg) {
          document.documentElement.style.setProperty(
            '--ring-offset',
            bg.join(' ')
          );
        }
        recompute();
      });

      // Load saved preferences
      document.addEventListener('DOMContentLoaded', function () {
        const savedProfile =
          localStorage.getItem('contrastProfile') || 'harmony';
        const savedAAA = localStorage.getItem('aaaMode') === 'true';

        document.getElementById('profileSelect').value = savedProfile;
        document.getElementById('aaaToggle').checked = savedAAA;

        // Save preferences on change
        document
          .getElementById('profileSelect')
          .addEventListener('change', function () {
            localStorage.setItem('contrastProfile', this.value);
          });

        document
          .getElementById('aaaToggle')
          .addEventListener('change', function () {
            localStorage.setItem('aaaMode', this.checked);
          });

        // Transparency toggle for glass demo
        let transparencyEnabled = true;
        document
          .getElementById('transparencyToggle')
          .addEventListener('click', function () {
            transparencyEnabled = !transparencyEnabled;
            document.documentElement.classList.toggle(
              'no-transparency',
              !transparencyEnabled
            );
            this.textContent = transparencyEnabled
              ? '🪟 Glass On'
              : '🚫 Glass Off';

            // Update demo description
            const demo = document.getElementById('glassDemo');
            if (!transparencyEnabled) {
              if (!demo.querySelector('.fallback-notice')) {
                const notice = document.createElement('div');
                notice.className = 'fallback-notice';
                notice.style.cssText = `
                position: absolute;
                top: 50px;
                left: 20px;
                right: 20px;
                background: rgba(var(--warning) / 0.1);
                border: 1px solid rgba(var(--warning) / 0.3);
                border-radius: 8px;
                padding: 12px;
                font-size: 12px;
                color: rgb(var(--warning));
                text-align: center;
                z-index: 5;
              `;
                notice.innerHTML = `
                <strong>Transparency Disabled</strong><br>
                Glass materials become solid surfaces for accessibility
              `;
                demo.appendChild(notice);
              }
            } else {
              const notice = demo.querySelector('.fallback-notice');
              if (notice) notice.remove();
            }
          });

        // Initial render
        recompute();
      });
    </script>
  </body>
</html>
